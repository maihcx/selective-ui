name: Sync after release

on:
  workflow_run:
    workflows: ["Auto publish release"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  sync:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Create PR from main to preview
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = 'main';
            const base = 'preview';
            const title = 'Auto pr version';
            const body = 'Auto pr version';
            const labels = ['skip-version-update', 'skip-changelogs'];

            const { data: comparison } = await github.rest.repos.compareCommitsWithBasehead({
              owner,
              repo,
              basehead: `${base}...${head}`,
            });

            if (comparison.ahead_by === 0) {
              core.info(`No changes to sync from ${head} to ${base}; skipping PR creation.`);
              return;
            }

            const { data: existing } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${head}`,
              base,
              per_page: 1,
            });

            let pr;
            if (existing.length > 0) {
              pr = existing[0];
              core.info(`PR already exists: #${pr.number}`);
            } else {
              const { data: created } = await github.rest.pulls.create({
                owner,
                repo,
                title,
                head,
                base,
                body,
              });
              pr = created;
              core.info(`Created PR #${pr.number}`);
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr.number,
              labels,
            });
